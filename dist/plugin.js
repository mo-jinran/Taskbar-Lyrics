function n(n){const[e,t]=n.split(":");return Number((60*Number(e)+Number(t)).toFixed(2))}async function e(e){try{const t=await fetch(`https://music.163.com/api/song/lyric/v1?tv=0&lv=0&rv=0&kv=0&yv=0&ytv=0&yrv=0&cp=false&id=${e}`);if(!t.ok)throw new Error(`Failed to fetch lyrics: ${t.status} ${t.statusText}`);return function(e){const t=[];try{const r=e.split("\n");for(const e of r)if("["==e[0]){const r=e.indexOf("]");if(-1===r)continue;const i={time:n(e.slice(1,r)),text:e.slice(r+1)};i.text.trim()&&t.push(i)}}catch(n){console.error("[Taskbar Lyrics] Error parsing lyrics:",n)}return t}((await t.json()).lrc.lyric)}catch(n){return console.error("[Taskbar Lyrics] Error fetching lyrics:",n),[]}}async function t(n){try{const e=await fetch(`https://music.163.com/api/song/detail?ids=[${n}]`);if(!e.ok)throw new Error(`Failed to fetch song details: ${e.status} ${e.statusText}`);const t=await e.json();return{name:t.songs[0].name,artists:t.songs[0].artists?.map((n=>n.name)).join(" / ")}}catch(n){return console.error("[Taskbar Lyrics] Error fetching song details:",n),{name:"Unknown",artists:"Unknown"}}}class r{constructor(n){this.callback=n,this.isLoaded=!1,this.lastIndex=-1,this.currentLyric=[];try{channel.registerCall("audioplayer.onLoad",this.onLoad.bind(this)),channel.registerCall("audioplayer.onPlayProgress",this.onPlayProgress.bind(this))}catch(n){console.error("[Taskbar Lyrics] Failed to register events:",n)}}async onLoad(...n){try{if(this.isLoaded=!1,this.lastIndex=-1,!n||!n[0])return;const r=n[0].split("_")[0],[i,o]=await Promise.all([t(r),e(r)]);this.currentLyric=[{time:-1,text:i.name},{time:-1,text:i.artists}].concat(o),this.isLoaded=!0,this.callback?.(this.currentLyric,0)}catch(n){console.error("[Taskbar Lyrics] Error in onLoad:",n),this.currentLyric=[{time:-1,text:"Error loading song"},{time:-1,text:n.message||"Unknown error"}],this.isLoaded=!0}}async onPlayProgress(...n){try{if(!this.isLoaded||this.currentLyric.length<=2)return;const e=n[1],t=this.currentLyric.findIndex((n=>n.time>=e)),r=(t<=-1?this.currentLyric.length:t)-1;this.lastIndex!=r&&(this.lastIndex=r,this.callback?.(this.currentLyric,r))}catch(n){console.error("[Taskbar Lyrics] Error in onPlayProgress:",n)}}}function i(n,e){const t=document.createElement("div");t.style.cssText="\n        display: flex;\n        margin-bottom: 10px;\n        align-items: center;\n        padding: 8px 12px;\n        border-radius: 6px;\n        background-color: #fafafa;\n        border: 1px solid #f0f0f0;\n        height: 40px;\n        box-sizing: border-box;\n    ";const r=document.createElement("div");r.textContent=n,r.style.cssText="\n        flex: 0 0 30%;\n        font-size: 14px;\n        font-weight: 500;\n        color: #333;\n    ";const i=document.createElement("div");return i.style.cssText="\n        flex: 0 0 70%;\n        display: flex;\n        align-items: center;\n    ",i.appendChild(e),t.appendChild(r),t.appendChild(i),t}function o(n,e,t){const r=document.createElement("select");r.style.cssText="\n        padding: 6px 10px;\n        border: 1px solid #e8e8e8;\n        border-radius: 4px;\n        min-width: 150px;\n        background-color: #fff;\n    ";for(const[t,i]of Object.entries(n)){const n=document.createElement("option");n.value=t,n.textContent=i,n.selected=t==e,r.appendChild(n)}return r.addEventListener("change",(()=>t(r.value))),r}function a(n,e){const t=document.createElement("div");t.style.cssText="\n        display: flex;\n        align-items: center;\n    ";const r=document.createElement("input");r.type="color",r.style.cssText="\n        width: 40px;\n        height: 25px;\n        border: none;\n        cursor: pointer;\n    ";const i=n>>24&255,o=n>>16&255,a=n>>8&255,s=255&n;r.value=`#${o.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}`;const c=document.createElement("input");c.type="number",c.min=0,c.max=255,c.value=i,c.style.cssText="\n        width: 60px !important;\n        min-width: 60px !important;\n        padding: 6px 10px;\n        border: 1px solid #e8e8e8;\n        border-radius: 4px;\n        background-color: #fff;\n    ";const d=document.createElement("span");d.textContent="透明度:",d.style.cssText="\n        margin: 0 10px 0 15px;\n        font-size: 13px;\n        color: #666;\n    ";const l=()=>{const n=r.value.substring(1),t=parseInt(n,16),i=255&parseInt(c.value);e(i<<24|t)};return r.addEventListener("change",l),c.addEventListener("change",l),t.appendChild(r),t.appendChild(d),t.appendChild(c),t}function s(n,e){const t=document.createElement("input");return t.type="number",t.value=n,t.style.cssText="\n        padding: 6px 10px;\n        border: 1px solid #e8e8e8;\n        border-radius: 4px;\n        min-width: 150px;\n        background-color: #fff;\n    ",t.addEventListener("change",(()=>e(parseInt(t.value)))),t}function c(n,e){const t=document.createElement("input");return t.type="checkbox",t.checked=n,t.style.cssText="\n        width: 16px;\n        height: 16px;\n        margin-right: 8px;\n    ",t.addEventListener("change",(()=>e(t.checked))),t}function d(n){const e=document.createElement("div");e.style.cssText="\n        margin-bottom: 20px;\n        border: 1px solid #e8e8e8;\n        border-radius: 8px;\n        padding: 15px;\n        background-color: #fff;\n    ";const t=document.createElement("h3");return t.textContent=n,t.style.cssText="\n        margin-top: 0;\n        margin-bottom: 15px;\n        padding-bottom: 8px;\n        border-bottom: 2px solid #1890ff;\n        color: #1890ff;\n        font-size: 16px;\n        font-weight: 600;\n    ",e.appendChild(t),e}const l=Object.freeze({LEADING:0,TRAILING:1,CENTER:2,JUSTIFIED:3}),p=Object.freeze({THIN:100,EXTRA_LIGHT:200,ULTRA_LIGHT:200,LIGHT:300,SEMI_LIGHT:350,NORMAL:400,REGULAR:400,MEDIUM:500,DEMI_BOLD:600,SEMI_BOLD:600,BOLD:700,EXTRA_BOLD:800,ULTRA_BOLD:800,BLACK:900,HEAVY:900,EXTRA_BLACK:950,ULTRA_BLACK:950}),h=Object.freeze({NORMAL:0,OBLIQUE:1,ITALIC:2}),y=Object.freeze({AUTO:0,LEFT:1,CENTER:2,RIGHT:3}),m=Object.freeze({lyric_primary:"",lyric_secondary:"",font_family:"Microsoft YaHei UI",margin_left:0,margin_right:0,window_alignment:y.AUTO,color_primary:4294967295,size_primary:14,underline_primary:!1,strikethrough_primary:!1,weight_primary:p.NORMAL,slope_primary:h.NORMAL,align_primary:l.LEADING,color_secondary:4294967295,size_secondary:14,underline_secondary:!1,strikethrough_secondary:!1,weight_secondary:p.NORMAL,slope_secondary:h.NORMAL,align_secondary:l.LEADING}),u=(()=>{const n=new Proxy({...m},{get:(n,e)=>plugin.getConfig(e,m[e]),set:(n,e,t)=>(plugin.setConfig(e,t),betterncm_native.native_plugin.call("taskbar_lyrics.config",[e,String(t)]),!0)});for(const e in m)n[e]=n[e];return n})();function g(){betterncm_native.native_plugin.call("taskbar_lyrics.update",[])}new class{constructor(){plugin.onLoad(this.onLoad.bind(this)),plugin.onConfig(this.onConfig.bind(this))}onLoad(){try{new r(((n,e)=>{try{u.lyric_primary=n[-1==n[e].time?0:e+(1&e)]?.text??"",u.lyric_secondary=n[-1==n[e].time?1:e+!(1&e)]?.text??"",g()}catch(n){console.error("[Taskbar Lyrics] Error updating lyrics:",n)}})),g()}catch(n){console.error("[Taskbar Lyrics] Failed to initialize plugin:",n)}}onConfig(){const n=function(){const n=document.createElement("div");return n.style.cssText="\n        font-family: 'Microsoft YaHei UI', sans-serif;\n        color: #333;\n        padding: 0;\n        margin: 0;\n    ",n}(),e=d("general");e.appendChild(i("字体",o(["Microsoft YaHei UI","SimSun","SimHei","KaiTi","Arial","Times New Roman","Consolas"],u.font_family,(n=>{u.font_family=n,g()})))),e.appendChild(i("左边距",s(u.margin_left,(n=>{u.margin_left=n,g()})))),e.appendChild(i("右边距",s(u.margin_right,(n=>{u.margin_right=n,g()})))),e.appendChild(i("窗口对齐方式",o({[y.AUTO]:"自动",[y.LEFT]:"左对齐",[y.CENTER]:"居中",[y.RIGHT]:"右对齐"},u.window_alignment,(n=>{u.window_alignment=parseInt(n),g()})))),n.appendChild(e);const t=d("primary");t.appendChild(i("颜色",a(u.color_primary,(n=>{u.color_primary=n,g()})))),t.appendChild(i("字体大小",s(u.size_primary,(n=>{u.size_primary=n,g()})))),t.appendChild(i("字体粗细",o({[p.THIN]:"极细",[p.LIGHT]:"细体",[p.NORMAL]:"正常",[p.MEDIUM]:"中等",[p.BOLD]:"粗体",[p.BLACK]:"超粗"},u.weight_primary,(n=>{u.weight_primary=parseInt(n),g()})))),t.appendChild(i("字体样式",o({[h.NORMAL]:"正常",[h.ITALIC]:"斜体（字体包含的设计）",[h.OBLIQUE]:"倾斜（强制将字符倾斜）"},u.slope_primary,(n=>{u.slope_primary=parseInt(n),g()})))),t.appendChild(i("下划线",c(u.underline_primary,(n=>{u.underline_primary=n,g()})))),t.appendChild(i("删除线",c(u.strikethrough_primary,(n=>{u.strikethrough_primary=n,g()})))),t.appendChild(i("文本对齐",o({[l.LEADING]:"左对齐",[l.CENTER]:"居中",[l.TRAILING]:"右对齐",[l.JUSTIFIED]:"两端对齐"},u.align_primary,(n=>{u.align_primary=parseInt(n),g()})))),n.appendChild(t);const r=d("secondary");return r.appendChild(i("颜色",a(u.color_secondary,(n=>{u.color_secondary=n,g()})))),r.appendChild(i("字体大小",s(u.size_secondary,(n=>{u.size_secondary=n,g()})))),r.appendChild(i("字体粗细",o({[p.THIN]:"极细",[p.LIGHT]:"细体",[p.NORMAL]:"正常",[p.MEDIUM]:"中等",[p.BOLD]:"粗体",[p.BLACK]:"超粗"},u.weight_secondary,(n=>{u.weight_secondary=parseInt(n),g()})))),r.appendChild(i("字体样式",o({[h.NORMAL]:"正常",[h.ITALIC]:"斜体（字体包含的设计）",[h.OBLIQUE]:"倾斜（强制将字符倾斜）"},u.slope_secondary,(n=>{u.slope_secondary=parseInt(n),g()})))),r.appendChild(i("下划线",c(u.underline_secondary,(n=>{u.underline_secondary=n,g()})))),r.appendChild(i("删除线",c(u.strikethrough_secondary,(n=>{u.strikethrough_secondary=n,g()})))),r.appendChild(i("文本对齐",o({[l.LEADING]:"左对齐",[l.CENTER]:"居中",[l.TRAILING]:"右对齐",[l.JUSTIFIED]:"两端对齐"},u.align_secondary,(n=>{u.align_secondary=parseInt(n),g()})))),n.appendChild(r),n}};
